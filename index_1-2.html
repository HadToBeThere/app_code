<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Had to Be There ‚Äî MVP+ Subs + PotW</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="app.css" />
</head>
<body>

  <!-- Splash (Press Start) -->
  <div id="splash" aria-modal="true" role="dialog">
    <div class="splash-wrap">
      <div class="apptitle">Had to Be There</div>
      <div class="bigq">What‚Äôs Happening Now?</div>
      <div class="logo-stack">
        <!-- Pin logo (purely decorative) -->
        <svg class="logo-pin" width="120" height="120" viewBox="0 0 100 100" aria-hidden="true">
          <defs>
            <linearGradient id="pinGrad" x1="0%" x2="0%" y1="0%" y2="100%">
              <stop offset="0%" stop-color="#fca5a5"/>
              <stop offset="100%" stop-color="#b91c1c"/>
            </linearGradient>
          </defs>
          <path d="M50 10c17 0 30 13 30 30 0 22-30 50-30 50S20 62 20 40c0-17 13-30 30-30z" fill="url(#pinGrad)"/>
          <circle cx="50" cy="40" r="9" fill="#fff"/>
        </svg>
        <!-- Globe Start Button -->
        <button id="startGlobe" class="logo-globe" aria-label="Press Start">
          <svg viewBox="0 0 200 200" width="160" height="160" aria-hidden="true">
            <defs>
              <radialGradient id="globeGrad" cx="50%" cy="45%" r="60%">
                <stop offset="0%"  stop-color="#9be8ff"/>
                <stop offset="100%" stop-color="#1d4ed8"/>
              </radialGradient>
            </defs>
            <circle cx="100" cy="100" r="78" fill="url(#globeGrad)" stroke="rgba(0,0,0,.25)" stroke-width="6"/>
            <!-- tiny land blobs -->
            <path d="M70 95c-10-8-8-22 6-28 16-8 30-3 34 10" fill="#10b981" opacity=".95"/>
            <path d="M120 120c8 6 19 5 24-2 7-9 5-21-7-26" fill="#10b981" opacity=".95"/>
          </svg>
          <div class="start-label">PRESS START</div>
        </button>
      </div>
      <div class="tagline">Ephemeral, hyper-local pings that vanish in 24h</div>
      
    </div>
  </div>

  <div id="app" class="prestart-scale">
    <div id="map"><div class="desat-hole"></div></div>

    <!-- Left sidebar (Filters only) -->
    <aside class="leftbar" id="leftbar" aria-label="Filters">
      <div class="section">
        <div><strong>Filter</strong></div>
        <div class="seg" id="filterSeg" style="margin-top:6px">
          <button data-mode="all" class="active">All</button>
          <button data-mode="friends">Friends+Me</button>
          <button data-mode="me">Me</button>
        </div>
      </div>
    </aside>

    

    <!-- Top center tray -->
    <div class="tray">
      <span class="pill" id="quotaText">0/3 pings today</span>
      <button class="pill" id="subscribeBtn" title="Subscribe (shows M badge)">M</button>
    </div>

    <!-- Right: notifications & profile -->
    <button class="bell" id="bellBtn">üîî <span class="badge" id="notifBadge" style="display:none">0</span></button>

    <!-- Top-right Sign in (visible when signed out) -->
    <button class="signin-top" id="signInTop">Sign in</button>

    <!-- Profile widget (avatar + name) -->
    <button class="profile-widget" id="profileWidget" aria-label="Profile">
      <div class="profile-avatar" id="profileAvatar" aria-hidden="true"></div>
      <div class="profile-name" id="profileName">Sign in</div>
    </button>

    <!-- Add Ping FAB -->
    <button class="fab" id="addBtn">+ Ping</button>

    <!-- Legend -->
    <div class="legend">
      <strong>Had to Be There</strong><br/>
      Drop a ping inside the circle. No names, no harassment. Posts vanish after 24h.<br/>
      Yours = green; friends = orange; others = blue; subscribers show as white ‚ÄúM‚Äù if not your friend.
    </div>

    <!-- Ping of the Week card -->
    <div id="potwCard" class="potw-card" role="region" aria-live="polite">
      <div class="potw-title">PING OF THE WEEK</div>
      <div class="potw-row">
        <img id="potwImg" alt="Ping of the Week image" style="display:none; width:60px; height:60px; object-fit:cover; border-radius:12px;"/>
        <div class="potw-body">
          <div class="potw-text" id="potwText"></div>
          <div class="potw-meta muted" id="potwMeta"></div>
          <div id="potwEmpty" class="muted">No ping of the week yet.</div>
        </div>
        <div class="potw-actions">
          <button class="btn" id="potwJump" disabled>View</button>
        </div>
      </div>
    </div>

    <!-- Notifications Modal -->
    <div class="modal" id="notifsModal" aria-modal="true" role="dialog">
      <div class="card">
        <header>
          <span>Notifications</span>
          <button class="btn" id="closeNotifs">Close</button>
        </header>
        <div class="content" id="notifsContent">
          <div class="muted">No notifications</div>
        </div>
      </div>
    </div>

    <!-- Create Ping Modal -->
    <div class="modal" id="createModal" aria-modal="true" role="dialog">
      <div class="card">
        <header>
          <span>Create Ping</span>
          <div style="display:flex; gap:8px">
            <button class="btn" id="cancelCreate">Cancel</button>
          </div>
        </header>
        <div class="content">
          <div class="row" style="gap:.5rem; align-items:center; margin-bottom:6px">
            <label class="btn" for="pingVisibility">Visibility</label>
            <select id="pingVisibility" class="btn" style="min-width:140px">
              <option value="public" selected>Public</option>
              <option value="private">Private (friends only)</option>
            </select>
          </div>
          <div class="row"><input id="pingText" type="text" maxlength="140" placeholder="What‚Äôs happening?" /></div>
          <div class="row" style="gap:.5rem; align-items:center">
            <label class="btn" id="attachLabel" for="pingImage">Attach Image</label>
            <input id="pingImage" type="file" accept="image/*" style="display:none" />
          </div>
          <div id="attachPreview" style="display:none; margin-top:8px; position:relative">
            <img id="attachPreviewImg" alt="Preview" style="max-width:100%; height:auto; border-radius:12px; border:1px solid #eee" />
            <button class="btn icon-btn" id="removeAttachBtn" aria-label="Remove image" title="Remove image" style="position:absolute;top:6px;right:6px">‚úï</button>
          </div>
          <input id="lat" type="hidden" />
          <input id="lon" type="hidden" />
        </div>
        <div class="actions">
          <button class="btn primary" id="submitPing" type="button">Ping</button>
        </div>
      </div>
    </div>

    <!-- Subscribe Modal -->
    <div class="modal" id="subscribeModal" aria-modal="true" role="dialog">
      <div class="card">
        <header>
          <span>Subscribe</span>
          <button class="btn" id="closeSub">Close</button>
        </header>
        <div class="content">
          <p>Subscribers get a subtle white ‚ÄúM‚Äù badge when seen by non-friends. No extra privileges beyond the badge.</p>
        </div>
        <div class="actions">
          <button class="btn primary" id="confirmSub">Subscribe</button>
        </div>
      </div>
    </div>

    <!-- Ping Sheet (details) -->
    <div class="sheet" id="pingSheet" role="dialog" aria-modal="true">
      <header>
        <div style="font-weight:900" id="pingSheetTitle">Ping</div>
        <div style="display:flex; gap:8px">
          <select id="reportReason" class="btn">
            <option value="">Report‚Ä¶</option>
            <option value="harassment">Harassment</option>
            <option value="doxxing">Personal info</option>
            <option value="spam">Spam</option>
            <option value="other">Other</option>
          </select>
          <button class="btn" id="closeSheet">Close</button>
        </div>
      </header>
      <div class="text" id="sheetText">‚Ä¶</div>
      <div style="padding:10px 14px"><button class="btn" id="viewImageBtn" style="display:none">View image</button></div>
      <div class="image" id="sheetImage" style="display:none"><img id="sheetImgEl" src="" alt="Ping image"/></div>
      <div class="meta" id="sheetMeta">‚Äî</div>
      <div class="reactbar" id="reactBar"></div>
      <div class="comments" id="comments"></div>
      <div class="comment-input" style="display:flex; gap:8px; padding:10px 14px; border-top:1px solid #eee;">
        <input id="commentInput" type="text" maxlength="200" placeholder="Add a comment" />
        <button class="btn" id="sendComment">Send</button>
      </div>
    </div>

    <!-- Sign-in Modal (Google-only) -->
    <div class="modal" id="signInModal" aria-modal="true" role="dialog">
      <div class="card">
        <header>
          <span>Sign in</span>
          <button class="btn" id="closeSignIn">Close</button>
        </header>
        <div class="content">
          <div class="row" style="justify-content:center">
            <button class="btn" id="doGoogle">Sign in with Google</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Profile Modal -->
    <div class="modal" id="profileModal" aria-modal="true" role="dialog">
      <div class="card">
        <header>
          <span id="profileModalTitle">Profile</span>
          <div style="display:flex; gap:8px; align-items:center">
            <button class="btn icon-btn" id="backToProfile" style="display:none">‚Üê</button>
            <button class="btn icon-btn" id="openSettings" title="Settings" style="display:none">‚öôÔ∏é</button>
            <button class="btn" id="closeProfile">Close</button>
          </div>
        </header>
        <div class="content" id="profileContent">
          <div id="ownProfileSection">
            <div class="row" style="gap:12px; align-items:center">
              <div class="profile-avatar large" id="ownProfileAvatar"></div>
              <div style="flex:1">
                <div class="muted" id="emailDisplay" style="margin-top:6px"></div>
              </div>
            </div>
            <div class="section" style="margin-top:12px">
              <div><strong>Add Friend</strong></div>
              <div class="row" style="gap:.5rem; margin-top:6px">
                <input id="addFriendInputProfile" type="text" placeholder="username or email" />
                <button class="btn" id="addFriendBtnProfile">Add</button>
              </div>
            </div>
            <div class="section" style="margin-top:12px">
              <div><strong>Requests</strong></div>
              <div id="requestsList" style="margin-top:6px">
                <div class="muted">No pending requests.</div>
              </div>
            </div>
            <div class="section" style="margin-top:12px">
              <div><strong>Friends</strong></div>
              <div id="profileFriendsList" style="margin-top:6px">
                <div class="muted">No friends yet.</div>
              </div>
            </div>
          </div>
          <div id="otherProfileSection" style="display:none">
            <div class="row" style="gap:12px; align-items:center">
              <div class="profile-avatar large" id="otherProfileAvatar"></div>
              <div>
                <div style="font-weight:900" id="otherProfileName">Friend</div>
              </div>
            </div>
          </div>
          <div id="settingsSection" style="display:none">
            <div class="section">
              <div><strong>Change profile picture</strong></div>
              <div class="row" style="gap:.5rem; margin-top:6px; align-items:center">
                <div class="profile-avatar large" id="settingsProfileAvatar" style="width:48px;height:48px;"></div>
                <label class="btn" for="settingsImageInput">Change profile pic</label>
                <input id="settingsImageInput" type="file" accept="image/*" style="position:fixed;left:-9999px;top:0;opacity:0" />
              </div>
            </div>
            <div class="section">
              <div><strong>Username</strong></div>
              <div class="row" style="gap:.5rem; margin-top:6px">
                <input id="handleInput" type="text" placeholder="username" />
                <button class="btn" id="saveHandle">Save username</button>
              </div>
            </div>
          </div>
        </div>
        <div class="actions" id="profileActions" style="justify-content:flex-end">
          <button class="btn" id="signOutInProfile" style="display:none">Sign out</button>
        </div>
      </div>
    </div>

    <!-- Image Lightbox -->
    <div class="modal" id="imageLightbox" aria-modal="true" role="dialog">
      <div class="card" style="max-width:min(90vw,900px)">
        <header>
          <span>Image</span>
          <button class="btn" id="closeLightbox">Close</button>
        </header>
        <div class="content" style="display:flex; justify-content:center">
          <img id="lightboxImg" alt="Image" style="max-width:100%; height:auto; image-rendering:auto; border-radius:12px; border:1px solid #eee" />
        </div>
      </div>
    </div>

    <!-- Avatar Crop Modal -->
    <div class="modal" id="cropModal" aria-modal="true" role="dialog">
      <div class="card">
        <header>
          <span>Adjust profile photo</span>
          <button class="btn" id="closeCrop">Cancel</button>
        </header>
        <div class="content">
          <div id="cropFrame" style="width:min(320px,80vw);height:min(320px,80vw);margin:0 auto;position:relative;border-radius:50%;overflow:hidden;border:1px solid #eee;box-shadow:inset 0 0 0 200vmax rgba(0,0,0,.25);">
            <img id="cropImage" alt="Crop" style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%) scale(1);user-select:none;touch-action:none;will-change:transform" />
          </div>
          <div class="row" style="gap:8px;align-items:center;justify-content:center;margin-top:10px">
            <input type="range" id="cropZoom" min="1" max="3" step="0.01" value="1" style="width:min(320px,80vw)" />
          </div>
        </div>
        <div class="actions">
          <button class="btn primary" id="saveCroppedAvatar">Save</button>
        </div>
      </div>
    </div>

    <!-- Toasts -->
    <div id="toast" role="status" aria-live="polite" aria-atomic="true"></div>
  </div>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>

  <!-- App -->
  <script src="app.js"></script>

  <!-- Show Sign Out button only when authed; delegate to chip click -->
  <script>
  (function(){
    var signOutBtn = document.getElementById('signOutBtn');
    if (signOutBtn) {
      signOutBtn.addEventListener('click', function(){
        var chip = document.getElementById('userChip');
        if (chip) chip.click();
      });
      try {
        var auth2 = firebase.auth();
        auth2.onAuthStateChanged(function(u){
          signOutBtn.style.display = u ? 'inline-flex' : 'none';
        });
      } catch(e) { console.warn('SignOut init failed', e); }
    }
  })();
  </script>
</body>
</html>









